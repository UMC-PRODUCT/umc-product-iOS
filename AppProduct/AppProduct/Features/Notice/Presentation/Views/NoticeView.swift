//
//  NoticeView.swift
//  AppProduct
//
//  Created by ì´ì˜ˆì§€ on 1/14/26.
//

import SwiftUI

// MARK: - NoticeView
/// ê³µì§€ì‚¬í•­ ë©”ì¸ í™”ë©´
struct NoticeView: View {

    // MARK: - Properties
    @State var viewModel = NoticeViewModel()
    @State private var search: String = ""
    
    // MARK: - Constants
    fileprivate enum Constants {
        static let listTopPadding: CGFloat = 10
    }

    // MARK: - Constants
    private enum Constants {
        static let listTopPadding: CGFloat = 10
        static let searchPlaceholder: String = "ì œëª©, ë‚´ìš© ê²€ìƒ‰"
    }
    // MARK: - Body
    var body: some View {
        Group {
            switch viewModel.noticeItems {
            case .idle:
                Color.clear.task {
                    print("API í•¨ìˆ˜")
                }
            case .loading:
                progressView
            case .loaded(let noticeItem):
                noticeCotent(noticeItem)
            case .failed(_):
                Color.clear
            }
        }
        .searchable(text: $search, prompt: Constants.searchPlaceholder)
        .searchToolbarBehavior(.minimize)
        .toolbar {
            ToolBarCollection.GenerationFilter(
                title: viewModel.selectedGeneration.title,
                generations: viewModel.generations,
                selection: $viewModel.selectedGeneration
            )
            ToolBarCollection.TopBarCenterMenu(
                      icon: viewModel.selectedNoticeMainFilter.labelIcon,
                      title: viewModel.selectedNoticeMainFilter.labelText,
                      items: viewModel.mainFilterItems,
                      selection: $viewModel.selectedNoticeMainFilter,
                      itemLabel: { $0.labelText },
                      itemIcon: { $0.labelIcon }
                  )
        }
        .safeAreaBar(edge: .top) {
            if showSubFilter {
                NoticeSubFilter(viewModel: viewModel)
                    .equatable()
            }
        }
        .navigationBarTitleDisplayMode(.inline)
    }
    
    // MARK: -
    private var progressView: some View {
        ProgressView(label: {
            Text("ê³µì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆì–´ìš”")
                .appFont(.callout)
        })
        .controlSize(.large)
        .tint(.indigo500)
        .frame(maxWidth: .infinity, maxHeight: .infinity)
    }
    
    // MARK: -
    @ViewBuilder
    private func noticeCotent(_ data: [NoticeItemModel]) -> some View {
        if data.isEmpty {
            unavailableContent
        } else {
            availableContent(data)
        }
    }
    
    // MARK: -
    private func availableContent(_ data: [NoticeItemModel]) -> some View {
        List(data) { item in
            NoticeItem(model: item)
                .listRowBackground(Color.clear)
                .listRowSeparator(.hidden)
                .listRowInsets(DefaultConstant.defaultListPadding)
        }
        .listStyle(.plain)
        .scrollContentBackground(.hidden)
    }
    
    // MARK: -
    private var unavailableContent: some View {
        ContentUnavailableView(
            "ì•„ì§ ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ì–´ìš”",
            systemImage: "exclamationmark.triangle.text.page",
            description: Text("ìš´ì˜ì§„ì´ ê³µì§€ì‚¬í•­ì„ ë“±ë¡í•˜ë©´ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤")
        )
        .tint(.indigo200.opacity(0.5))
    }
    
    // MARK: - Computed Properties
    /// ì„œë¸Œí•„í„° í‘œì‹œ ì—¬ë¶€ (ì¤‘ì•™/ì§€ë¶€/í•™êµì¼ ë•Œë§Œ í‘œì‹œ)
    private var showSubFilter: Bool {
        switch viewModel.selectedNoticeMainFilter {
        case .all, .part: return false
        case .central, .branch, .school: return true
        }
    }
}


// MARK: - NoticeSubFilter
/// ì„œë¸Œí•„í„° ì˜ì—­ (ì „ì²´, ìš´ì˜ì§„ ê³µì§€ ì¹© + íŒŒíŠ¸ ë©”ë‰´)
private struct NoticeSubFilter: View, Equatable {

    @Bindable var viewModel = NoticeViewModel()

    static func == (lhs: NoticeSubFilter, rhs: NoticeSubFilter) -> Bool {
        lhs.viewModel.selectedNoticeSubFilter == rhs.viewModel.selectedNoticeSubFilter &&
        lhs.viewModel.selectedPart == rhs.viewModel.selectedPart
    }

    private enum Constants {
        static let hstackSpacing: CGFloat = 8
    }

    private var subFilterItems: [NoticeSubFilterType] {
        [.all, .management]
    }

    var body: some View {
        ScrollView(.horizontal, showsIndicators: false) {
            HStack(spacing: Constants.hstackSpacing) {
                ForEach(subFilterItems) { filter in
                    filterChip(for: filter)
                }
                PartFilterMenu(viewModel: viewModel)
                    .equatable()
            }
            .padding(.horizontal, DefaultConstant.defaultSafeHorizon)
        }
    }

    /// ì¹©ë²„íŠ¼ ìƒì„±
    @ViewBuilder
    private func filterChip(for filter: NoticeSubFilterType) -> some View {
        ChipButton(
            filter.labelText,
            isSelected: viewModel.selectedNoticeSubFilter == filter
        ) {
            viewModel.selectedNoticeSubFilter = filter
        }
        .buttonSize(.medium)
    }
}

// MARK: - PartFilterMenu
/// íŒŒíŠ¸ ì„ íƒ ë©”ë‰´
private struct PartFilterMenu: View, Equatable {

    @Bindable var viewModel = NoticeViewModel()

    static func == (lhs: PartFilterMenu, rhs: PartFilterMenu) -> Bool {
        lhs.viewModel.selectedPart == rhs.viewModel.selectedPart
    }

    private enum Constants {
        static let hstackSpacing: CGFloat = 4
        static let chevronSize: CGFloat = 10
        static let chipPadding: EdgeInsets = .init(top: 8, leading: 16, bottom: 8, trailing: 16)
    }

    var body: some View {
        Menu {
            partPicker
        } label: {
            menuLabel
        }
    }

    /// íŒŒíŠ¸ Picker
    private var partPicker: some View {
        Picker("íŒŒíŠ¸ ì„ íƒ", selection: $viewModel.selectedPart) {
            ForEach(Part.allCases) { part in
                Text(part.name)
                    .tag(part as Part?)
            }
        }
        .pickerStyle(.inline)
    }

    /// íŒŒíŠ¸ê°€ ì‹¤ì œë¡œ ì„ íƒë˜ì—ˆëŠ”ì§€ (ê¸°ë³¸ê°’ "íŒŒíŠ¸"ê°€ ì•„ë‹Œ ê²½ìš°)
    private var isPartSelected: Bool {
        viewModel.selectedPart != .all && viewModel.selectedPart != nil
    }
    
    /// ë©”ë‰´ ë¼ë²¨
    private var menuLabel: some View {
        HStack(spacing: Constants.hstackSpacing) {
            Text(viewModel.selectedPart?.name ?? "íŒŒíŠ¸")
                .appFont(.subheadline, weight: .bold)
            Image(systemName: "chevron.down")
                .font(.system(size: Constants.chevronSize))
        }
        .foregroundStyle(isPartSelected ? .grey000 : .grey600)
        .padding(Constants.chipPadding)
        .clipShape(Capsule())
        .background {
            Capsule()
                .fill(isPartSelected ? .indigo500 : .grey200)
        }
        .glassEffect(.clear.interactive(), in: Capsule())
    }
}

// MARK: - Preview
#Preview("Loading") {
    NavigationStack {
        NoticeView(viewModel: {
            let vm = NoticeViewModel()
            vm.noticeItems = .loading
            return vm
        }())
    }
}

#Preview("Loaded - ë°ì´í„° ìˆìŒ") {
    NavigationStack {
        NoticeView(viewModel: {
            let vm = NoticeViewModel()
            vm.noticeItems = .loaded([
                NoticeItemModel(generation: 9, tag: .campus, mustRead: true, isAlert: true, date: Date(), title: "2026ë…„ë„ UMC ì‹ ë…„íšŒ ì•ˆë‚´", content: "ì•ˆë…•í•˜ì„¸ìš”! UMC ë„ˆë“œ ë° ì±Œë¦°ì € ì—¬ëŸ¬ë¶„ ì•ˆë…•í•˜ì„¸ìš”! íšŒì¥ ì›°ì‹œì…ë‹ˆë‹¤! ì‹ ë…„íšŒê¹Œì§€ ì–´ëŠë§ ëª‡ ì£¼ ë‚¨ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤ ğŸ¥³ ì˜¤ëŠ˜ì€ ì‹ ë…„íšŒì— ì•ì„œ ëª‡ ê°€ì§€ ì „ë‹¬ë“œë¦´ ì‚¬í•­ì´ ìˆì–´ ê³µì§€ë“œë¦½ë‹ˆë‹¤.", writer: "ì›°ì‹œ/ìµœì§€ì€", hasLink: true, hasVote: false, viewCount: 32),
                NoticeItemModel(generation: 9, tag: .campus, mustRead: true, isAlert: true, date: Date(), title: "9ê¸° ìŠ¤í„°ë”” í›„ê¸° ì´ë²¤íŠ¸ ë¦¬ë§ˆì¸ë“œ", content: "9ê¸° ê°€ì²œëŒ€ UMC ì±Œë¦°ì € ì—¬ëŸ¬ë¶„ ì•ˆë…•í•˜ì„¸ìš”. ë‚˜ë‚˜ì…ë‹ˆë‹¤! ì•„ì§ 9ê¸° ìŠ¤í„°ë”” í›„ê¸°ë¥¼ ì‘ì„±í•˜ì§€ ì•Šìœ¼ì‹  ë¶„ë“¤ê»˜ ë¦¬ë§ˆì¸ë“œ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤!", writer: "ë‚˜ë‚˜/ì´ì˜ˆë‚˜", hasLink: true, hasVote: false, viewCount: 48),
                NoticeItemModel(generation: 9, tag: .central, mustRead: true, isAlert: true, date: Date(), title: "UMC 9ê¸° âœ¨Demo Dayâœ¨ ì•ˆë‚´", content: "ì•ˆë…•í•˜ì„¸ìš”, UMC 9ê¸° ì±Œë¦°ì € ì—¬ëŸ¬ë¶„! ì´ê´„ ì±—ì±—ì…ë‹ˆë‹¤~", writer: "ì³‡ì³‡/ì „ì±„ìš´", hasLink: false, hasVote: false, viewCount: 123),
                NoticeItemModel(generation: 9, tag: .part(.ios), mustRead: false, isAlert: false, date: Date(), title: "iOS 9ì£¼ì°¨ ì›Œí¬ë¶ ë°°í¬ ì•ˆë‚´", content: "ì•ˆë…•í•˜ì„¸ìš”! ê°€ì²œëŒ€í•™êµ UMC iOS ì±Œë¦°ì € ì—¬ëŸ¬ë¶„! íŒŒíŠ¸ì¥ ì†Œí”¼ì…ë‹ˆë‹¤â˜ºï¸ 10ì£¼ì°¨ ì›Œí¬ë¶ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! 10ì£¼ì°¨ëŠ” ì •ê·œ ì›Œí¬ë¶ë§Œ ìˆìŠµë‹ˆë‹¤! 10ì£¼ì°¨ëŠ” iOS ì›Œí¬ë¶ â€¼ï¸ìµœì´ˆë¡œâ€¼ï¸ ë¶€ë‹´ í•˜ë‚˜ ì—†ì´ 30ë¶„ì•ˆì— ëë‚¼ ìˆ˜ ìˆëŠ” ê°œë…ê³¼ ê³¼ì œì…ë‹ˆë‹¤!", writer: "ì†Œí”¼/ì´ì˜ˆì§€", hasLink: false, hasVote: false, viewCount: 5),
                NoticeItemModel(generation: 10, tag: .part(.ios), mustRead: false, isAlert: false, date: Date(), title: "iOS 9ì£¼ì°¨ ì›Œí¬ë¶ ë°°í¬ ì•ˆë‚´", content: "ì•ˆë…•í•˜ì„¸ìš”! UMC 10ê¸° iOS ì±Œë¦°ì € ì—¬ëŸ¬ë¶„! ì¤‘ì•™íŒŒíŠ¸ì¥ ì†Œí”¼ì…ë‹ˆë‹¤â˜ºï¸", writer: "ì†Œí”¼/ì´ì˜ˆì§€", hasLink: false, hasVote: false, viewCount: 98),
                NoticeItemModel(generation: 10, tag: .part(.android), mustRead: false, isAlert: false, date: Date(), title: "iOS 9ì£¼ì°¨ ì›Œí¬ë¶ ë°°í¬ ì•ˆë‚´", content: "ì•ˆë…•í•˜ì„¸ìš”! Android ì±Œë¦°ì € ì—¬ëŸ¬ë¶„! ë¦¬ì•”ì…ë‹ˆë‹¤.ğŸŒªï¸ ë‹¤ë“¤ ì§€ê¸ˆê¹Œì§€ì˜ ì›Œí¬ë¶ì€ ì˜ ìµíˆì…¨ë‚˜ìš”?? 7, 8ì£¼ì°¨ ì›Œí¬ë¶ì€ ë³¸ê²©ì ìœ¼ë¡œ DBì— ëŒ€í•´ íƒêµ¬í•´ë³´ëŠ” ì›Œí¬ë¶ì…ë‹ˆë‹¤.", writer: "ë¦¬ì•”/ì¡°ì„±ì¤€", hasLink: false, hasVote: false, viewCount: 6),
                NoticeItemModel(generation: 9, tag: .part(.nodejs), mustRead: false, isAlert: false, date: Date(), title: "iOS 9ì£¼ì°¨ ì›Œí¬ë¶ ë°°í¬ ì•ˆë‚´", content: "ì•ˆë…•í•˜ì„¸ìš”! Node ì±Œë¦°ì € ì—¬ëŸ¬ë¶„! ì˜Œì°Œì…ë‹ˆë‹¤.ğŸ‘» 10ì£¼ì°¨ ìŠ¤í„°ë””ê°€ ì´ë²ˆì£¼ë¡œ ë‹¤ë“¤ ëë‚˜ë„¤ìš”! ë‹¤ë“¤ ë„ˆë¬´ ìˆ˜ê³  ë§ìœ¼ì…¨ì–´ìš”!", writer: "ì˜Œì°Œ/ì¥ì˜ˆì€", hasLink: false, hasVote: false, viewCount: 8),
                NoticeItemModel(generation: 9, tag: .part(.springboot), mustRead: false, isAlert: false, date: Date(), title: "iOS 9ì£¼ì°¨ ì›Œí¬ë¶ ë°°í¬ ì•ˆë‚´", content: "ì•ˆë…•í•˜ì„¸ìš” ë…¸ì„ì…ë‹ˆë‹¤ ğŸ’› â—â— 8ì£¼ì°¨ í”¼ë“œë°± ì™„ë£Œë˜ì—ˆê³ , Infra ì›Œí¬ë¶ 2ê°œì™€ ë¶€ë¡ í•˜ë‚˜ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤ â—â—ì´ì œ ê°ì PRì— ë¦¬ë·°ê°€ ì¦‰ê° ë°˜ì˜ë˜ì—ˆì„ê²ë‹ˆë‹¤..ã…ã…", writer: "ë…¸ì„/ë…¸ì°½ì¤€", hasLink: false, hasVote: false, viewCount: 12)
            ])
            return vm
        }())
    }
}

#Preview("Loaded - ë¹ˆ ë°ì´í„°") {
    NavigationStack {
        NoticeView(viewModel: {
            let vm = NoticeViewModel()
            vm.noticeItems = .loaded([])
            return vm
        }())
    }
}
